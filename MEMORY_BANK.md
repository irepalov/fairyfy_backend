# Memory Bank - Fairytales Backend

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–æ–∫ —á–µ—Ä–µ–∑ n8n

#### –ö–æ–Ω—Ç–µ–∫—Å—Ç
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: Firebase Firestore
- –§—É–Ω–∫—Ü–∏–∏: Firebase Cloud Functions
- –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å: n8n –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å–∫–∞–∑–æ–∫
- –ö–ª–∏–µ–Ω—Ç: –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

#### –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ó–∞–ø—Ä–æ—Å –≤ n8n —Å –±—ç–∫–µ–Ω–¥–∞ (–Ω–µ —Å –º–æ–±–∏–ª–∫–∏)

**–ü—Ä–∏—á–∏–Ω—ã:**
1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - API –∫–ª—é—á–∏ –∏ credentials –¥–ª—è n8n –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è
3. **–ö–æ–Ω—Ç—Ä–æ–ª—å** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ n8n
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** - –±—ç–∫–µ–Ω–¥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç `taleText` –≤ Firebase

---

## –ü–æ–¥—Ö–æ–¥—ã –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–Ω–µ –≤—ã–±—Ä–∞–Ω, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
–ú–æ–±–∏–ª–∫–∞ ‚Üí generateTaleContent(taleId) ‚Üí [–û–ñ–ò–î–ê–ù–ò–ï]
    ‚Üì
–ë—ç–∫–µ–Ω–¥ ‚Üí n8n ‚Üí [–û–ñ–ò–î–ê–ù–ò–ï] ‚Üí –æ—Ç–≤–µ—Ç —Å taleText
    ‚Üì
–ë—ç–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç taleText ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    ‚Üì
–ú–æ–±–∏–ª–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç
```

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:** –≥–µ–Ω–µ—Ä–∞—Ü–∏—è < 30-60 —Å–µ–∫—É–Ω–¥

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- –ú–æ–±–∏–ª–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–∑—É –≤ –æ—Ç–≤–µ—Ç–µ

**–ú–∏–Ω—É—Å—ã:**
- Firebase Cloud Functions —Ç–∞–π–º–∞—É—Ç (–º–∞–∫—Å 540 —Å–µ–∫)
- –ï—Å–ª–∏ —é–∑–µ—Ä –∑–∞–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –∑–∞–ø—Ä–æ—Å –æ–±–æ—Ä–≤—ë—Ç—Å—è
- –ï—Å–ª–∏ —Å–µ—Ç—å –ø—Ä–æ–ø–∞–¥—ë—Ç - –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
export const generateTaleContent = functions.https.onCall(async (data, context) => {
  await taleRef.update({ completionStatus: FairyTaleStatus.GENERATING });
  
  // –ñ–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç n8n
  const generatedText = await generateStoryWithAI(tale.components, tale.taleStyle);
  
  await taleRef.update({
    taleText: generatedText,
    completionStatus: FairyTaleStatus.COMPLETED,
  });
  
  return { success: true, taleText: generatedText };
});
```

**–ù–∞ –º–æ–±–∏–ª–∫–µ:**
```dart
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
showLoader();

// –ñ–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
final result = await generateTaleContent(taleId);

// –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∞–∑–∫—É
hideLoader();
showTale(result.taleText);
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–í–´–ë–†–ê–ù)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
–ú–æ–±–∏–ª–∫–∞ ‚Üí generateTaleContent(taleId) ‚Üí —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ—Ç { status: 'GENERATING' }
    ‚Üì
–ú–æ–±–∏–ª–∫–∞ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Firestore
    ‚Üì
–ë—ç–∫–µ–Ω–¥ (–≤ —Ñ–æ–Ω–µ) ‚Üí n8n ‚Üí –ø–æ–ª—É—á–∞–µ—Ç taleText ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Firestore
    ‚Üì
–ú–æ–±–∏–ª–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Firestore listener ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:** –≥–µ–Ω–µ—Ä–∞—Ü–∏—è > 60 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

**–ü–ª—é—Å—ã:**
- –Æ–∑–µ—Ä –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
- –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- –ë–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ –ø—Ä–∏ –ø–ª–æ—Ö–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ

**–ú–∏–Ω—É—Å—ã:**
- –ß—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- –ù—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Firestore –Ω–∞ –º–æ–±–∏–ª–∫–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
```typescript
// 1. –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–∞–∑—É)
export const generateTaleContent = functions.https.onCall(async (data, context) => {
  await taleRef.update({ completionStatus: FairyTaleStatus.GENERATING });
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–ë–ï–ó await!)
  generateAndSave(taleId, tale);
  
  // –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
  return { 
    success: true, 
    status: FairyTaleStatus.GENERATING 
  };
});

// 2. –§–æ–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
async function generateAndSave(taleId: string, tale: any) {
  const taleRef = db.collection('fairyTales').doc(taleId);
  
  try {
    const generatedText = await generateStoryWithAI(tale.components, tale.taleStyle);
    
    await taleRef.update({
      taleText: generatedText,
      completionStatus: FairyTaleStatus.COMPLETED,
    });
  } catch (error) {
    await taleRef.update({
      completionStatus: FairyTaleStatus.FAILED,
    });
  }
}
```

**–ù–∞ –º–æ–±–∏–ª–∫–µ:**
```dart
// –í—ã–∑—ã–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
await generateTaleContent(taleId);

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
FirebaseFirestore.instance
  .collection('fairyTales')
  .doc(taleId)
  .snapshots()
  .listen((snapshot) {
    final status = snapshot.data()?['completionStatus'];
    
    if (status == 'COMPLETED') {
      final taleText = snapshot.data()?['taleText'];
      hideLoader();
      showTale(taleText);
    } else if (status == 'FAILED') {
      hideLoader();
      showError();
    }
    // –ï—Å–ª–∏ GENERATING - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–∞–¥–µ—Ä
  });
```

---

## Flow –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫–∞–∑–∫–∏

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–∑–∫–∏** (–º–æ–±–∏–ª–∫–∞ ‚Üí `createFairyTale`)
   - –°–æ–∑–¥–∞—ë—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `DRAFT`
   - `taleText` –ø—É—Å—Ç–æ–π

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** (–º–æ–±–∏–ª–∫–∞ ‚Üí `updateFairyTale`)
   - –Æ–∑–µ—Ä –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç: hero, friends, equipment, villains, places, taleStyle
   - –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞—ë—Ç—Å—è `DRAFT`

3. **–ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** (–º–æ–±–∏–ª–∫–∞ ‚Üí `generateTaleContent`)
   - –ë—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
   - –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `GENERATING`
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
   - –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –º–æ–±–∏–ª–∫–µ

4. **–§–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** (–±—ç–∫–µ–Ω–¥)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ n8n —Å –ø–æ–ª–Ω—ã–º JSON (components + taleStyle)
   - –ñ–¥—ë—Ç –æ—Ç–≤–µ—Ç (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `taleText` –≤ Firestore
   - –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `COMPLETED` –∏–ª–∏ `FAILED`

5. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** (–º–æ–±–∏–ª–∫–∞)
   - –ß–µ—Ä–µ–∑ Firestore listener –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å–∫–∞–∑–∫—É –∏–ª–∏ –æ—à–∏–±–∫—É

---

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ `generateTaleContent`):**
- `hero.name` - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
- `taleStyle.style` - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
- –î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã (friends, equipment, villains, places)

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

1. ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞**
   - –§—É–Ω–∫—Ü–∏—è `generateTaleContent` —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `GENERATING`
   - –§–æ–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `generateAndSave` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ n8n
   - –¢–∞–π–º–∞—É—Ç —Ñ—É–Ω–∫—Ü–∏–∏: 540 —Å–µ–∫—É–Ω–¥ (9 –º–∏–Ω—É—Ç)
   - –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ n8n: 480 —Å–µ–∫—É–Ω–¥ (8 –º–∏–Ω—É—Ç)

2. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `hero.name`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `taleStyle.style`
   - –û—à–∏–±–∫–∞ `failed-precondition` –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

3. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –õ–æ–≥–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ n8n
   - –õ–æ–≥–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞
   - –õ–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç n8n**
   - –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–µ–π: `taleText`, `story`, `text`, `output`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
   - –ó–∞–ø–∏—Å—å –≤ –ø–æ–ª–µ `taleText` –≤ Firestore

5. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
   - –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞
   - –û—à–∏–±–∫–∏ HTTP
   - –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `FAILED` –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

### –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –≤ production:
- –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π: 2026-01-03
- –§—É–Ω–∫—Ü–∏—è: `generateTaleContent`
- –†–µ–≥–∏–æ–Ω: `europe-west1`

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **–†–µ–≥–∏–æ–Ω Firebase:** `europe-west1`
- **–¢–∞–π–º–∞—É—Ç —Ñ—É–Ω–∫—Ü–∏–∏:** 540 —Å–µ–∫—É–Ω–¥ (9 –º–∏–Ω—É—Ç)
- **–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ n8n:** 480 —Å–µ–∫—É–Ω–¥ (8 –º–∏–Ω—É—Ç)
- **n8n webhook URL:** `https://n8n.fairyfy.xyz/webhook/ac502c37-56b8-4241-ba8a-7e82ee932cfb`

---

## API –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. createFairyTale
**Request:**
```json
{
  "title": "Test Tale",
  "components": {
    "hero": {
      "name": "Knight Arthur",
      "type": "knight"
    },
    "friends": [],
    "equipment": [],
    "villains": [{
      "name": "Dragon",
      "type": "dragon"
    }],
    "places": [{
      "name": "Dark Forest",
      "kind": "forest"
    }]
  },
  "taleStyle": {
    "style": "adventure"
  }
}
```
**Response:**
```json
{
  "success": true,
  "taleId": "abc123xyz",
  "message": "Tale created successfully"
}
```

### 2. generateTaleContent
**Request:**
```json
{
  "taleId": "abc123xyz"
}
```
**Response (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):**
```json
{
  "success": true,
  "status": "GENERATING",
  "message": "Tale generation started"
}
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ Firestore
- –û—Ç–∫—Ä—ã—Ç—å Firebase Console ‚Üí Firestore
- –ö–æ–ª–ª–µ–∫—Ü–∏—è: `fairyTales`
- –î–æ–∫—É–º–µ–Ω—Ç: `{taleId}`
- –°–ª–µ–¥–∏—Ç—å –∑–∞ –ø–æ–ª–µ–º `completionStatus`:
  - `GENERATING` ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞
  - `COMPLETED` ‚Üí —Å–º–æ—Ç—Ä–µ—Ç—å `taleText`
  - `FAILED` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

---

## n8n Integration

### –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ n8n:
```json
{
  "models": {
    "hero": { "name": "...", "type": "..." },
    "friends": [...],
    "equipment": [...],
    "villains": [...],
    "places": [...]
  },
  "taleStyle": {
    "style": "..."
  }
}
```

### –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç –æ—Ç n8n:
**–§–æ—Ä–º–∞—Ç:** n8n –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤**
```json
[
  {
    "taleText": "–ñ–∏–ª-–±—ã–ª –æ–¥–∏–Ω–æ–∫–∏–π –≥–µ—Ä–æ–π..."
  }
]
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è** (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):
- `taleText` (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ)
- `story`
- `text`
- `output`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∫–æ–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –º–∞—Å—Å–∏–≤–æ–º
2. –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ - –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `result[0].taleText`
3. –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) - `result.taleText`
4. –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
- –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Üí —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `taleText`, —Å—Ç–∞—Ç—É—Å ‚Üí `COMPLETED`
- –û—à–∏–±–∫–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç ‚Üí —Å—Ç–∞—Ç—É—Å ‚Üí `FAILED`, `taleText` –æ—Å—Ç–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º

---

## Troubleshooting & Bug Fixes

### –ë–∞–≥: taleText –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è, —Å—Ç–∞—Ç—É—Å FAILED (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω 04.01.2026)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ n8n —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø–æ–ª–µ `taleText` –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –ø—É—Å—Ç—ã–º, –∞ `completionStatus` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª—Å—è –≤ `FAILED`.

**–ü—Ä–∏—á–∏–Ω–∞:**
n8n webhook –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ **–º–∞—Å—Å–∏–≤–∞**:
```json
[
  {
    "taleText": "–ñ–∏–ª-–±—ã–ª –æ–¥–∏–Ω–æ–∫–∏–π –≥–µ—Ä–æ–π..."
  }
]
```

–ù–æ –∫–æ–¥ –æ–∂–∏–¥–∞–ª –æ–±—ä–µ–∫—Ç –∏ –ø—ã—Ç–∞–ª—Å—è –∏–∑–≤–ª–µ—á—å `result.taleText` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ—Ä–Ω—è. –≠—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª–æ `undefined`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ `FAILED`.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `generateStoryWithAI`:

```typescript
// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ taleText –∏–∑ –æ—Ç–≤–µ—Ç–∞
let taleText: string | undefined;

if (Array.isArray(result) && result.length > 0) {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞: [{"taleText": "..."}]
  taleText = result[0].taleText || result[0].story || result[0].text || result[0].output;
} else {
  // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –æ–±—ä–µ–∫—Ç–æ–º
  taleText = result.taleText || result.story || result.text || result.output;
}
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—è–ª–∏ –ª–æ–≥–∏ Firebase Functions: `firebase functions:log`
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ webhook –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `curl`

**–î–µ–ø–ª–æ–π:**
- –î–∞—Ç–∞: 2026-01-04 13:44 UTC
- –ö–æ–º–∞–Ω–¥–∞: `firebase deploy --only functions:generateTaleContent`
- –°—Ç–∞—Ç—É—Å: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫–∞–∑–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- –¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `taleText`
- –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `COMPLETED`

---

## API Endpoints - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **Production URL:** `https://europe-west1-fairytales-app.cloudfunctions.net`
- **–†–µ–≥–∏–æ–Ω:** `europe-west1`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç Firebase ID Token –≤ header `Authorization: Bearer {token}`
- **–§–æ—Ä–º–∞—Ç:** Firebase Callable Functions (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ `{ "data": {...} }`)

---

### 1. createFairyTale

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–∫–∞–∑–∫—É –≤ —Å—Ç–∞—Ç—É—Å–µ DRAFT (—á–µ—Ä–Ω–æ–≤–∏–∫) –≤ Firestore.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è Firebase Authentication (`context.auth`)
2. –í–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
   - `title` - –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
   - `components.hero` - –æ–±—ä–µ–∫—Ç —Å `name` –∏ `type`
   - `taleStyle.style` - –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
3. –ò–∑ Firestore —á–∏—Ç–∞–µ—Ç—Å—è `userName` —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`users/{userId}`)
4. –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `fairyTales`:
   - `userId`, `userName` - –∏–∑ auth –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - `title` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∞–∑–∫–∏
   - `taleText` - –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
   - `completionStatus` - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `DRAFT`
   - `components` - –≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –ø—Ä–µ–¥–º–µ—Ç—ã, –º–µ—Å—Ç–∞
   - `taleStyle` - —Å—Ç–∏–ª—å –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
   - `createdAt`, `updatedAt` - Firebase Timestamp
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `taleId` –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**Request:**
```json
{
  "data": {
    "title": "–í–µ–ª–∏–∫–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –≥–µ—Ä–æ–µ–≤",
    "components": {
      "hero": {
        "name": "–ê—Ä—Ç—É—Ä",
        "type": "knight"
      },
      "friends": [
        { "name": "–ú–µ—Ä–ª–∏–Ω", "type": "wizard" },
        { "name": "–ì–≤–∏–Ω–µ–≤—Ä–∞", "type": "princess" }
      ],
      "equipment": [
        { "name": "–≠–∫—Å–∫–∞–ª–∏–±—É—Ä", "description": "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—á" }
      ],
      "villains": [
        { "name": "–ú–æ—Ä–≥–∞–Ω–∞", "type": "witch" },
        { "name": "–î—Ä–∞–∫–æ–Ω", "type": "dragon" }
      ],
      "places": [
        { "name": "–ö–∞–º–µ–ª–æ—Ç", "kind": "–∑–∞–º–æ–∫" },
        { "name": "–¢–µ–º–Ω—ã–π –ª–µ—Å", "kind": "–ª–µ—Å" }
      ]
    },
    "taleStyle": {
      "style": "–≠–ø–∏—á–µ—Å–∫–∞—è —Ñ—ç–Ω—Ç–µ–∑–∏"
    }
  }
}
```

**Response:**
```json
{
  "result": {
    "success": true,
    "taleId": "abc123xyz",
    "message": "Tale created successfully"
  }
}
```

**–í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–∫–∏:**
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `DRAFT` –∏ –Ω–µ –∏–º–µ–µ—Ç —Ç–µ–∫—Å—Ç–∞
- –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `generateTaleContent` —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º `taleId`
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `title`, `hero`, `taleStyle`
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã: `friends`, `equipment`, `villains`, `places` (–º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏)

---

### 2. generateTaleContent

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–ó–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ —Å–∫–∞–∑–∫–∏ —á–µ—Ä–µ–∑ n8n webhook.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–ø–æ—à–∞–≥–æ–≤–æ):**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (`tale.userId === context.auth.uid`)
2. –ß–∏—Ç–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç —Å–∫–∞–∑–∫–∏ –∏–∑ Firestore –ø–æ `taleId`
3. –í–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
   - `hero.name` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω
   - `taleStyle.style` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω
4. –°—Ç–∞—Ç—É—Å —Å–∫–∞–∑–∫–∏ **–°–†–ê–ó–£** –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `GENERATING` –≤ Firestore
5. –§—É–Ω–∫—Ü–∏—è **–ù–ï–ú–ï–î–õ–ï–ù–ù–û** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ –∂–¥–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!)
6. –í **–§–û–ù–û–í–û–ú –†–ï–ñ–ò–ú–ï** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `generateAndSave()`:
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ n8n webhook: `https://n8n.fairyfy.xyz/webhook-test/...`
   - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: `{ models: components, taleStyle: taleStyle }`
   - –û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç n8n (timeout 8 –º–∏–Ω—É—Ç)
   - –ò–∑ –æ—Ç–≤–µ—Ç–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `taleText` (–∏–ª–∏ `story`/`text`/`output`)
   - **–ü—Ä–∏ —É—Å–ø–µ—Ö–µ:** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `taleText` –∏ —Å—Ç–∞—Ç—É—Å ‚Üí `COMPLETED`
   - **–ü—Ä–∏ –æ—à–∏–±–∫–µ:** —Å—Ç–∞—Ç—É—Å ‚Üí `FAILED`
7. –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –≤ Firestore (–ø–æ–ª–µ `updatedAt` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)

**Request:**
```json
{
  "data": {
    "taleId": "abc123xyz"
  }
}
```

**Response (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –°–†–ê–ó–£):**
```json
{
  "result": {
    "success": true,
    "status": "GENERATING",
    "message": "Tale generation started"
  }
}
```

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:**

**–≠—Ç–æ—Ç endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –°–†–ê–ó–£, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!**

–ú–æ–±–∏–ª–∫–∞ **–î–û–õ–ñ–ù–ê** —Å–ª—É—à–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Firestore —á–µ—Ä–µ–∑ Firebase SDK:

```dart
// 1. –í—ã–∑–≤–∞—Ç—å generateTaleContent
await generateTaleContent(taleId);

// 2. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç { status: "GENERATING" }

// 3. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
FirebaseFirestore.instance
  .collection('fairyTales')
  .doc(taleId)
  .snapshots()
  .listen((snapshot) {
    final status = snapshot.data()?['completionStatus'];
    
    if (status == 'COMPLETED') {
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
      final taleText = snapshot.data()?['taleText'];
      hideLoader();
      showTale(taleText);
    } else if (status == 'FAILED') {
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π
      hideLoader();
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∞–∑–∫—É');
    } else if (status == 'GENERATING') {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å loader
      showLoader();
    }
  });
```

**–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ—Ç 30 —Å–µ–∫—É–Ω–¥ –¥–æ 8 –º–∏–Ω—É—Ç
- Timeout Cloud Function: 540 —Å–µ–∫—É–Ω–¥ (9 –º–∏–Ω—É—Ç)
- Timeout –∑–∞–ø—Ä–æ—Å–∞ –∫ n8n: 480 —Å–µ–∫—É–Ω–¥ (8 –º–∏–Ω—É—Ç)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
```json
{
  "userId": "user123",
  "userName": "–ò–≤–∞–Ω",
  "title": "–í–µ–ª–∏–∫–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ",
  "taleText": "",
  "completionStatus": "GENERATING",
  "components": { ... },
  "taleStyle": { ... },
  "createdAt": Timestamp,
  "updatedAt": Timestamp
}
```

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**
```json
{
  ...
  "taleText": "–î–∞–≤–Ω—ã–º-–¥–∞–≤–Ω–æ –≤ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–µ...",
  "completionStatus": "COMPLETED",
  "updatedAt": Timestamp  // –û–±–Ω–æ–≤–ª–µ–Ω
}
```

---

### 3. getUserTales

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–∫–∞–∑–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
2. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è Firestore query:
   - `WHERE userId == context.auth.uid`
   - `ORDER BY createdAt DESC` (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
   - `LIMIT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20, –º–∞–∫—Å–∏–º—É–º 50)
3. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `startAfter` - –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ —Å–∫–∞–∑–æ–∫ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: `hasMore` (–µ—Å—Ç—å –ª–∏ –µ—â–µ —Å–∫–∞–∑–∫–∏) –∏ `lastId` (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

**Request:**
```json
{
  "data": {
    "limit": 20
  }
}
```

**Request —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π:**
```json
{
  "data": {
    "limit": 20,
    "startAfter": "lastIdFromPreviousResponse"
  }
}
```

**Response:**
```json
{
  "result": {
    "tales": [
      {
        "id": "tale123",
        "userId": "user456",
        "userName": "–ò–≤–∞–Ω",
        "title": "–í–µ–ª–∏–∫–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ",
        "taleText": "–î–∞–≤–Ω—ã–º-–¥–∞–≤–Ω–æ...",
        "completionStatus": "COMPLETED",
        "components": { ... },
        "taleStyle": { "style": "–≠–ø–∏—á–µ—Å–∫–∞—è —Ñ—ç–Ω—Ç–µ–∑–∏" },
        "createdAt": { "_seconds": 1704398925, "_nanoseconds": 0 },
        "updatedAt": { "_seconds": 1704399125, "_nanoseconds": 0 }
      }
    ],
    "hasMore": true,
    "lastId": "tale123"
  }
}
```

**–í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–∫–∏:**
- –°–∫–∞–∑–∫–∏ —Å `completionStatus = DRAFT` –∏–º–µ—é—Ç –ø—É—Å—Ç–æ–π `taleText`
- –°–∫–∞–∑–∫–∏ —Å `completionStatus = GENERATING` –µ—â–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è (–ø–æ–∫–∞–∑–∞—Ç—å loader)
- –°–∫–∞–∑–∫–∏ —Å `completionStatus = COMPLETED` –≥–æ—Ç–æ–≤—ã –∫ –ø–æ–∫–∞–∑—É
- –°–∫–∞–∑–∫–∏ —Å `completionStatus = FAILED` –∏–º–µ—é—Ç –æ—à–∏–±–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `lastId` –≤ `startAfter`

---

### 4. updateFairyTale

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∫–∞–∑–∫—É (–æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π).

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (`tale.userId === context.auth.uid`)
2. –ß–∏—Ç–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–∫–∞–∑–∫–∏ –∏–∑ Firestore
3. –í–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è:
   - `title` - –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
   - `taleStyle.style` - –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
   - `components.hero` - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è components)
4. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `updates` —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
5. –î–ª—è `components` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω `hero` - –∑–∞–º–µ–Ω—è–µ—Ç—Å—è
   - –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã `friends`/`equipment`/`villains`/`places` - –±–µ—Ä—É—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
6. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç –≤ Firestore (`updatedAt` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
7. `completionStatus` –ù–ï –º–µ–Ω—è–µ—Ç—Å—è (–æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º)

**Request (–ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ):**
```json
{
  "data": {
    "taleId": "abc123xyz",
    "title": "–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
    "components": {
      "hero": { "name": "–ê—Ä—Ç—É—Ä –í–µ–ª–∏–∫–∏–π", "type": "knight" },
      "friends": [{ "name": "–ú–µ—Ä–ª–∏–Ω", "type": "wizard" }],
      "equipment": [],
      "villains": [{ "name": "–ú–æ—Ä–≥–∞–Ω–∞", "type": "witch" }],
      "places": [{ "name": "–ö–∞–º–µ–ª–æ—Ç", "kind": "–∑–∞–º–æ–∫" }]
    },
    "taleStyle": {
      "style": "–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Ñ—ç–Ω—Ç–µ–∑–∏"
    }
  }
}
```

**Request (—á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ title):**
```json
{
  "data": {
    "taleId": "abc123xyz",
    "title": "–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
  }
}
```

**Request (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º):**
```json
{
  "data": {
    "taleId": "abc123xyz",
    "taleText": "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç..."
  }
}
```

**Response:**
```json
{
  "result": {
    "success": true,
    "message": "Tale updated successfully"
  }
}
```

**–í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–∫–∏:**
- –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–µ –ø–æ–ª–µ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π —Å—Ä–∞–∑—É
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `generateTaleContent` –∑–∞–Ω–æ–≤–æ –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ï—Å–ª–∏ —Å–∫–∞–∑–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ `GENERATING` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
- –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å

---

### 5. deleteFairyTale

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–£–¥–∞–ª—è–µ—Ç —Å–∫–∞–∑–∫—É –∏–∑ Firestore (–Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è).

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
2. –ß–∏—Ç–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç —Å–∫–∞–∑–∫–∏ –∏–∑ Firestore –ø–æ `taleId`
3. –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (`tale.userId === context.auth.uid`)
4. –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `fairyTales`
5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

**Request:**
```json
{
  "data": {
    "taleId": "abc123xyz"
  }
}
```

**Response:**
```json
{
  "result": {
    "success": true,
    "message": "Tale deleted successfully"
  }
}
```

**–í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–∫–∏:**
- –ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç—å confirmation dialog
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–∫–∞–∑–æ–∫
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—É—à–∞–ª —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ `onSnapshot` - –æ–Ω –ø–æ–ª—É—á–∏—Ç `null`

---

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

**EntityType (–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π):**
- `knight` - —Ä—ã—Ü–∞—Ä—å
- `wizard` - –≤–æ–ª—à–µ–±–Ω–∏–∫
- `princess` - –ø—Ä–∏–Ω—Ü–µ—Å—Å–∞
- `fairy` - —Ñ–µ—è
- `dragon` - –¥—Ä–∞–∫–æ–Ω
- `witch` - –≤–µ–¥—å–º–∞

**FairyTaleStatus (—Å—Ç–∞—Ç—É—Å—ã —Å–∫–∞–∑–∫–∏):**
- `DRAFT` - —á–µ—Ä–Ω–æ–≤–∏–∫ (—Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞—Å—å)
- `GENERATING` - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- `COMPLETED` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ (`taleText` –∑–∞–ø–æ–ª–Ω–µ–Ω)
- `FAILED` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π (`taleText` –ø—É—Å—Ç–æ–π)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
```typescript
components: {
  hero: { name: string, type: EntityType },           // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
  friends: [{ name: string, type: EntityType }],      // –ú–∞—Å—Å–∏–≤
  equipment: [{ name: string, description?: string }], // –ú–∞—Å—Å–∏–≤
  villains: [{ name: string, type: EntityType }],     // –ú–∞—Å—Å–∏–≤
  places: [{ name: string, kind: string }]            // –ú–∞—Å—Å–∏–≤
}
```

---

### Firebase Errors

–í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç Cloud Functions:

- `unauthenticated` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–Ω–µ—Ç/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω)
- `invalid-argument` - –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞)
- `not-found` - —Å–∫–∞–∑–∫–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
- `permission-denied` - –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —Å–∫–∞–∑–∫–∏)
- `failed-precondition` - –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–µ–¥—É—Å–ª–æ–≤–∏—è (–Ω–µ—Ç hero/taleStyle –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π Flow –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–∫–∏

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É**  
   - title, hero, friends, villains, places, taleStyle

2. **–í—ã–∑–æ–≤ `createFairyTale`**  
   - –ü–æ–ª—É—á–∞–µ–º `taleId` –≤ –æ—Ç–≤–µ—Ç–µ

3. **–í—ã–∑–æ–≤ `generateTaleContent`**  
   - –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º `taleId`
   - –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç `{ status: "GENERATING" }`

4. **–ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI —Å loader**  
   - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
   - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è

5. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Firestore listener**  
   - `db.collection('fairyTales').doc(taleId).onSnapshot()`
   - –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è `completionStatus`

6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**  
   - `COMPLETED` ‚Üí —Å–∫—Ä—ã—Ç—å loader, –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏
   - `FAILED` ‚Üí —Å–∫—Ä—ã—Ç—å loader, –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"

---

### n8n Integration Details

**Webhook URL:**  
`https://n8n.fairyfy.xyz/webhook-test/ac502c37-56b8-4241-ba8a-7e82ee932cfb`

**–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ n8n:**
```json
{
  "models": {
    "hero": { "name": "...", "type": "..." },
    "friends": [...],
    "equipment": [...],
    "villains": [...],
    "places": [...]
  },
  "taleStyle": {
    "style": "..."
  }
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç –æ—Ç n8n (–º–∞—Å—Å–∏–≤):**
```json
[
  {
    "taleText": "–ñ–∏–ª-–±—ã–ª –æ–¥–∏–Ω–æ–∫–∏–π –≥–µ—Ä–æ–π..."
  }
]
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è –æ—Ç–≤–µ—Ç–∞:**  
(–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
- `taleText` (–æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ)
- `story`
- `text`
- `output`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∫–æ–¥–µ:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç –º–∞—Å—Å–∏–≤–æ–º
2. –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ - –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `result[0].taleText`
3. –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) - `result.taleText`
4. –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π

### 6. getAvailableObjects ‚≠ê –í–´–ë–†–ê–ù–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–∑–æ–∫ (–≥–µ—Ä–æ–∏, –¥—Ä—É–∑—å—è, –∑–ª–æ–¥–µ–∏, –º–µ—Å—Ç–∞, —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ, —Å—Ç–∏–ª–∏) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π –Ω–∞ –Ω—É–∂–Ω—ã–π —è–∑—ã–∫.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**  
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–∫–∞–∑–∫–∏
- –ü—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–ø–æ—à–∞–≥–æ–≤–æ):**
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è `language` –ø–∞—Ä–∞–º–µ—Ç—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `en`)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è in-memory –∫—ç—à (TTL: 5 —Å–µ–∫—É–Ω–¥)
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ –∏ —Å–≤–µ–∂–∏–µ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ!)
   - –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª ‚Üí –∑–∞–ø—Ä–æ—Å –∫ Firestore
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è Firestore query:
   ```typescript
   db.collection('objects')
     .where('isActive', '==', true)
     .orderBy('sortOrder')
   ```
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–æ–¥:
   - –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∑—è—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —è–∑—ã–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ru`)
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí fallback –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (`en`)
   - –ï—Å–ª–∏ –Ω–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ ‚Üí –±–µ—Ä–µ—Ç –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —è–∑—ã–∫
5. –û–±—ä–µ–∫—Ç—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
   - `heroes` - –≥–ª–∞–≤–Ω—ã–µ –≥–µ—Ä–æ–∏
   - `friends` - –¥—Ä—É–∑—å—è/–ø–æ–º–æ—â–Ω–∏–∫–∏
   - `villains` - –∑–ª–æ–¥–µ–∏/–∞–Ω—Ç–∞–≥–æ–Ω–∏—Å—Ç—ã
   - `places` - –ª–æ–∫–∞—Ü–∏–∏
   - `equipment` - –ø—Ä–µ–¥–º–µ—Ç—ã/—Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ
   - `taleStyles` - —Å—Ç–∏–ª–∏ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
6. –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É

**‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ –ù–ï authenticated endpoint!**
- –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –±–µ–∑ Firebase —Ç–æ–∫–µ–Ω–∞
- –î–∞–Ω–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π

**Request:**
```json
{
  "data": {
    "language": "ru"
  }
}
```

**Request (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π):**
```json
{
  "data": {}
}
```

**Response:**
```json
{
  "result": {
    "heroes": [
      {
        "id": "hero-wizard-001",
        "category": "hero",
        "imageUrl": "https://via.placeholder.com/400/9400D3/FFFFFF?text=Wizard",
        "sortOrder": 2,
        "title": "–í–æ–ª—à–µ–±–Ω–∏–∫",
        "description": "–ú—É–¥—Ä—ã–π –º–∞–≥, –∑–Ω–∞—é—â–∏–π –¥—Ä–µ–≤–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –∏ –º–∞–≥–∏—é"
      },
      {
        "id": "hero-knight-001",
        "category": "hero",
        "imageUrl": "https://via.placeholder.com/400/FF6347/FFFFFF?text=Knight",
        "sortOrder": 1,
        "title": "–†—ã—Ü–∞—Ä—å",
        "description": "–•—Ä–∞–±—Ä—ã–π –≤–æ–∏–Ω –≤ —Å–∏—è—é—â–∏—Ö –¥–æ—Å–ø–µ—Ö–∞—Ö"
      }
    ],
    "friends": [
      {
        "id": "friend-red-dog-001",
        "category": "friend",
        "imageUrl": "https://via.placeholder.com/400/FF6347/FFFFFF?text=Red+Dog",
        "sortOrder": 2,
        "title": "–†—ã–∂–∞—è —Å–æ–±–∞–∫–∞",
        "description": "–ò–≥—Ä–∏–≤—ã–π –∫–æ–º–ø–∞–Ω—å–æ–Ω —Å —Ä—ã–∂–µ–π —à–µ—Ä—Å—Ç—å—é –∏ –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π"
      },
      {
        "id": "friend-cat-001",
        "category": "friend",
        "imageUrl": "https://via.placeholder.com/400/FFD700/000000?text=Cat",
        "sortOrder": 1,
        "title": "–ö–æ—Ç",
        "description": "–•–∏—Ç—Ä—ã–π –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–ø—É—Ç–Ω–∏–∫"
      }
    ],
    "villains": [
      {
        "id": "villain-dragon-001",
        "category": "villain",
        "imageUrl": "https://via.placeholder.com/400/8B0000/FFFFFF?text=Dragon",
        "sortOrder": 1,
        "title": "–î—Ä–∞–∫–æ–Ω",
        "description": "–û–≥–Ω–µ–¥—ã—à–∞—â–µ–µ —á—É–¥–æ–≤–∏—â–µ, –æ—Ö—Ä–∞–Ω—è—é—â–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–∞"
      },
      {
        "id": "villain-witch-001",
        "category": "villain",
        "imageUrl": "https://via.placeholder.com/400/4B0082/FFFFFF?text=Witch",
        "sortOrder": 2,
        "title": "–í–µ–¥—å–º–∞",
        "description": "–¢–µ–º–Ω–∞—è –∫–æ–ª–¥—É–Ω—å—è —Å –∫–æ–≤–∞—Ä–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏"
      }
    ],
    "places": [
      {
        "id": "place-castle-001",
        "category": "place",
        "imageUrl": "https://via.placeholder.com/400/708090/FFFFFF?text=Castle",
        "sortOrder": 1,
        "title": "–ó–∞–º–æ–∫",
        "description": "–í–µ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—Ä–µ–ø–æ—Å—Ç—å —Å –≤—ã—Å–æ–∫–∏–º–∏ –±–∞—à–Ω—è–º–∏"
      },
      {
        "id": "place-forest-001",
        "category": "place",
        "imageUrl": "https://via.placeholder.com/400/228B22/FFFFFF?text=Forest",
        "sortOrder": 2,
        "title": "–õ–µ—Å",
        "description": "–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –¥—Ä–µ–º—É—á–∏–π –ª–µ—Å –ø–æ–ª–Ω—ã–π –∑–∞–≥–∞–¥–æ–∫"
      }
    ],
    "equipment": [
      {
        "id": "equip-sword-001",
        "category": "equipment",
        "imageUrl": "https://via.placeholder.com/400/C0C0C0/000000?text=Sword",
        "sortOrder": 1,
        "title": "–ú–µ—á",
        "description": "–û—Å—Ç—Ä—ã–π –∫–ª–∏–Ω–æ–∫ –¥–ª—è –±–∏—Ç–≤"
      },
      {
        "id": "equip-shield-001",
        "category": "equipment",
        "imageUrl": "https://via.placeholder.com/400/4682B4/FFFFFF?text=Shield",
        "sortOrder": 2,
        "title": "–©–∏—Ç",
        "description": "–ü—Ä–æ—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞—Ä–æ–≤"
      }
    ],
    "taleStyles": [
      {
        "id": "style-adventure-001",
        "category": "style",
        "imageUrl": "https://via.placeholder.com/400/FF6984/FFFFFF?text=Adventure",
        "sortOrder": 1,
        "title": "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ",
        "description": "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –∏—Å—Ç–æ—Ä–∏—è, –ø–æ–ª–Ω–∞—è –æ–ø–∞—Å–Ω–æ—Å—Ç–µ–π –∏ –æ—Ç–∫—Ä—ã—Ç–∏–π"
      },
      {
        "id": "style-comedy-001",
        "category": "style",
        "imageUrl": "https://via.placeholder.com/400/FF6984/FFFFFF?text=Comedy",
        "sortOrder": 2,
        "title": "–ö–æ–º–µ–¥–∏—è",
        "description": "–í–µ—Å–µ–ª–∞—è –∏ –±–µ–∑–∑–∞–±–æ—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è, –ø–æ–ª–Ω–∞—è —é–º–æ—Ä–∞"
      }
    ]
  }
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏:**
- `en` - English (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `ru` - –†—É—Å—Å–∫–∏–π
- `de` - Deutsch (–ù–µ–º–µ—Ü–∫–∏–π)
- –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ Firestore

**–í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–∫–∏:**
- –î–∞–Ω–Ω—ã–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–µ
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–∞–∫–∂–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –¥–ª—è offline mode
- –û–±—ä–µ–∫—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `sortOrder` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤ UI
- –ï—Å–ª–∏ `imageUrl` –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑–∞—Ç—å placeholder
- –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å `title` –∏ `description` –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Firestore (`objects` collection):**
```typescript
{
  id: "hero-wizard-001",
  category: "hero",
  imageUrl: "https://...",
  sortOrder: 2,
  isActive: true,
  translations: {
    en: {
      title: "Wizard",
      description: "A wise magician who knows ancient spells and magic"
    },
    ru: {
      title: "–í–æ–ª—à–µ–±–Ω–∏–∫",
      description: "–ú—É–¥—Ä—ã–π –º–∞–≥, –∑–Ω–∞—é—â–∏–π –¥—Ä–µ–≤–Ω–∏–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –∏ –º–∞–≥–∏—é"
    },
    de: {
      title: "Zauberer",
      description: "Ein weiser Magier, der alte Zauberspr√ºche kennt"
    }
  },
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

**Firestore Indexes (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´!):**

–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —ç—Ç–æ–≥–æ endpoint —Ç—Ä–µ–±—É—é—Ç—Å—è —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:

```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "objects",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "sortOrder", "order": "ASCENDING" }
      ]
    }
  ]
}
```

**–î–µ–ø–ª–æ–π –∏–Ω–¥–µ–∫—Å–æ–≤:**
```bash
firebase deploy --only firestore:indexes
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤:**
```bash
firebase firestore:indexes
```

‚ö†Ô∏è **–ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ** - –æ–±—ã—á–Ω–æ 1-5 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π flow):**

1. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   ```dart
   // –ü–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   final language = await getAppLanguage(); // 'en', 'ru', 'de'
   
   // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
   final catalog = await getAvailableObjects(language);
   
   // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
   await saveCatalogToCache(catalog);
   ```

2. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫–∞–∑–∫–∏:**
   ```dart
   // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ—è
   showHeroPicker(catalog.heroes);
   
   // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –¥—Ä—É–∑–µ–π
   showFriendsPicker(catalog.friends);
   
   // –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
   ```

3. **–ü—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞:**
   ```dart
   // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ–Ω—è–ª —è–∑—ã–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
   await setAppLanguage('de');
   
   // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
   final newCatalog = await getAvailableObjects('de');
   
   // –û–±–Ω–æ–≤–∏—Ç—å UI
   setState(() { catalog = newCatalog; });
   ```

---

## Troubleshooting: getAvailableObjects

### –û—à–∏–±–∫–∞: "500 Internal Server Error: Failed to fetch available objects" (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ 19.01.2026)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `getAvailableObjects` endpoint –≤–æ–∑–≤—Ä–∞—â–∞–ª `500` –æ—à–∏–±–∫—É:
```json
{
  "error": {
    "message": "Failed to fetch available objects",
    "status": "INTERNAL"
  }
}
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Cloud Functions:**
   ```bash
   firebase functions:log --only getAvailableObjects
   ```

2. **–ù–∞–π–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö:**
   ```
   Error: 9 FAILED_PRECONDITION: The query requires an index. 
   You can create it here: https://console.firebase.google.com/v1/r/project/fairyfy/firestore/indexes?create_composite=...
   ```

3. **–î–µ—Ç–∞–ª–∏:**
   - Error code: `9`
   - Error type: `FAILED_PRECONDITION`
   - –ü—Ä–∏—á–∏–Ω–∞: Firestore query `.where('isActive', '==', true).orderBy('sortOrder')` —Ç—Ä–µ–±—É–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å

**–ü—Ä–∏—á–∏–Ω–∞:**
Firestore —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –ª—é–±–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- `.where()` –Ω–∞ –æ–¥–Ω–æ–º –ø–æ–ª–µ
- `.orderBy()` –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ–ª–µ

–í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ:
```typescript
db.collection('objects')
  .where('isActive', '==', true)  // –§–∏–ª—å—Ç—Ä –ø–æ isActive
  .orderBy('sortOrder')            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ sortOrder
```

–¢–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å, –≤–∫–ª—é—á–∞—é—â–∏–π –æ–±–∞ –ø–æ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:**

1. **–î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –≤ `firestore.indexes.json`:**
   ```json
   {
     "indexes": [
       {
         "collectionGroup": "objects",
         "queryScope": "COLLECTION",
         "fields": [
           { "fieldPath": "isActive", "order": "ASCENDING" },
           { "fieldPath": "sortOrder", "order": "ASCENDING" }
         ]
       }
     ]
   }
   ```

2. **–ó–∞–¥–µ–ø–ª–æ–µ–Ω –∏–Ω–¥–µ–∫—Å:**
   ```bash
   firebase deploy --only firestore:indexes
   ```
   
   –í—ã–≤–æ–¥:
   ```
   ‚úî firestore: deployed indexes in firestore.indexes.json successfully
   ```

3. **–ü—Ä–æ–≤–µ—Ä–µ–Ω —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞:**
   ```bash
   firebase firestore:indexes
   ```
   
   –ò–Ω–¥–µ–∫—Å –≤–∏–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ:
   ```json
   {
     "collectionGroup": "objects",
     "fields": [
       { "fieldPath": "isActive", "order": "ASCENDING" },
       { "fieldPath": "sortOrder", "order": "ASCENDING" },
       { "fieldPath": "__name__", "order": "ASCENDING" }
     ],
     "density": "SPARSE_ALL"
   }
   ```

**–í—Ä–µ–º—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:**
- –û–±—ã—á–Ω–æ: 1-2 –º–∏–Ω—É—Ç—ã
- –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `objects`
- –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ: ~1 –º–∏–Ω—É—Ç–∞ (–æ–∫–æ–ª–æ 10 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –î–∞—Ç–∞: 2026-01-19 19:41 UTC
- –ú–µ—Ç–æ–¥: Postman POST –∑–∞–ø—Ä–æ—Å
- URL: `https://europe-west1-fairyfy.cloudfunctions.net/getAvailableObjects`
- Body: `{ "data": { "language": "en" } }`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
- Response time: ~591 ms
- Response size: 413 B (—Å –∫—ç—à–µ–º –±—É–¥–µ—Ç –µ—â–µ –±—ã—Å—Ç—Ä–µ–µ)

**–ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤–æ–∑–Ω–∏–∫–ª–∞ —Ä–∞–Ω—å—à–µ:**
- –£ –Ω–∞—Å —É–∂–µ –±—ã–ª –∏–Ω–¥–µ–∫—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `category`:
  ```json
  {
    "fields": [
      { "fieldPath": "category", "order": "ASCENDING" },
      { "fieldPath": "isActive", "order": "ASCENDING" },
      { "fieldPath": "sortOrder", "order": "ASCENDING" }
    ]
  }
  ```
- –ù–æ –∑–∞–ø—Ä–æ—Å –≤ `getAvailableObjects` –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ `category`
- –ü–æ—ç—Ç–æ–º—É –Ω—É–∂–µ–Ω –±—ã–ª –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –±–µ–∑ `category`

**–í–∞–∂–Ω—ã–µ —É—Ä–æ–∫–∏:**
1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏** –ø—Ä–∏ `500` –æ—à–∏–±–∫–∞—Ö: `firebase functions:log`
2. **Firestore –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –¥–ª—è —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **–ò–Ω–¥–µ–∫—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ `firestore.indexes.json`** –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoints —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è** —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –¥–æ production

**–°—Ç–∞—Ç—É—Å:**
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ  
üìÖ –î–∞—Ç–∞: 2026-01-19  
üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: WARP AI Agent

---
